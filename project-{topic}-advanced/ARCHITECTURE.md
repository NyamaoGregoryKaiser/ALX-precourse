# Authentication System Architecture

This document outlines the high-level architecture and key components of the C++-based Authentication System.

## 1. High-Level Overview

The system is a monolithic web application built with the Drogon C++ framework. It provides RESTful APIs for authentication and user management, along with basic server-rendered HTML pages. It interacts with a PostgreSQL database for data persistence and leverages Docker for containerization.

```mermaid
graph TD
    A[Client: Web Browser / API Consumer] -->|HTTP/HTTPS| B(Load Balancer / Reverse Proxy - Nginx)
    B --> C(Auth System Application - Drogon C++)
    C -->|Database Connection| D[PostgreSQL Database]

    subgraph Auth System Application
        C1[HTTP Server] --&gt; C2(Middleware Chain)
        C2 --&gt; C3(Controllers)
        C3 --&gt; C4(Services)
        C4 --&gt; C5[Models (ORM)]
        C2 --&gt; C6(Error Handler)
        C4 --&gt; C7[Cache Layer]
        C2 --&gt; C8[Rate Limiter]
        C1 --&gt; C9(Static File Server)
        C1 --&gt; C10(DView Template Engine)
    end

    subgraph External Components
        D --&gt; E[Persistent Storage: Docker Volume / EBS]
        C --&gt; F[Logging System: stdout/files]
        C --&gt; G[Monitoring (e.g., Prometheus Exporter, not implemented)]
        C --> H[Secrets Management (e.g., K8s Secrets, Env Vars)]
    end
```

## 2. Core Components

### 2.1. Drogon Web Framework

*   **HTTP Server:** Handles incoming HTTP requests and routes them to appropriate controllers.
*   **Asynchronous I/O:** Drogon is built on an event-driven, non-blocking I/O model, allowing for high concurrency.
*   **ORM (Object-Relational Mapping):** Simplifies database interactions by mapping C++ objects to database tables.
*   **Templating Engine (DView):** Used for server-side rendering of HTML pages for the basic "frontend."
*   **HTTP Client:** Used within integration tests to simulate client requests.

### 2.2. Layers

#### a. Controllers (`src/controllers/`)

*   Act as the entry points for API requests and web pages.
*   Responsible for parsing request data, delegating business logic to services, and formatting responses.
*   Handle HTTP-specific concerns (e.g., request/response objects, status codes).

#### b. Services (`src/services/`)

*   Encapsulate the core business logic of the application.
*   `AuthService`: Handles user registration, login, logout, and token blacklisting.
*   `UserService`: Manages CRUD operations for users and role assignments.
*   `JWTHelper`: Utility for generating and validating JWT tokens.
*   `PasswordHasher`: Handles secure password hashing (BCrypt).
*   `CacheService`: In-memory caching for performance optimization.
*   `RateLimiter`: Implements IP-based rate limiting.
*   Designed to be independent of HTTP context.

#### c. Models (`src/models/`)

*   Represent the data structures (e.g., `User`, `Role`, `Session`).
*   Generated by Drogon's ORM (partially hand-tuned for custom methods like `User::getRoles`).
*   Handle basic data validation and persistence logic via ORM mappers.

#### d. Middleware (`src/middleware/`)

*   Interceptors that process requests before they reach controllers or after controller logic.
*   **`LoggingMiddleware`**: Logs incoming request details.
*   **`RateLimiterFilter`**: Checks and enforces rate limits based on client IP.
*   **`AuthMiddleware`**: Validates JWT tokens and enforces Role-Based Access Control (RBAC). Injects user details (ID, roles) into the request context.
*   **`ErrorHandler`**: A global custom error handler for consistent error responses.

#### e. Utilities (`src/utils/`)

*   Helper functions for common tasks (e.g., `JsonUtil` for consistent JSON responses, `StringUtil` for string manipulation).

#### f. Constants (`src/constants/`)

*   Centralized location for application-wide constants, such as JWT settings, role names, and error messages.

### 2.3. Database Layer

*   **PostgreSQL:** Chosen for its robustness, reliability, and rich feature set.
*   **Drogon ORM:** Used for seamless interaction with the database, simplifying data operations and preventing SQL injection.
*   **Migrations:** SQL scripts (`db/migrations`) manage schema evolution.
*   **Seed Data:** `db/seed` provides initial data for development and testing environments.

### 2.4. Frontend ("C++ Frontend")

*   The "frontend" aspect in C++ is handled by Drogon's DView template engine.
*   `WebController` serves `client/views/*.html` templates (e.g., `login.html`, `register.html`).
*   Static assets (CSS, JS) are served from `client/public`.
*   This approach keeps the entire core application within C++, fulfilling the prompt's requirement without resorting to complex WebAssembly or an external JavaScript framework.

## 3. Security Considerations

*   **Password Hashing:** Uses `bcrypt` (or a strong fallback hash for demonstration) via `PasswordHasher`.
*   **JWT Security:**
    *   `JWT_SECRET` stored as an environment variable (not in source control).
    *   Tokens are signed with HS256 algorithm.
    *   Expiration times are enforced.
    *   `sessions` table acts as a simple JWT invalidation/blacklist mechanism for logout.
*   **Rate Limiting:** Protects authentication endpoints from brute-force attacks.
*   **HTTPS:** Recommended in production (handled by load balancer/reverse proxy, not directly in the Drogon app in this setup).
*   **Input Validation:** Handled in controllers and services.
*   **Role-Based Access Control (RBAC):** `AuthMiddleware` enforces permissions based on user roles.

## 4. Environment & Deployment

*   **Configuration:** `config/default.json` for app settings, `.env` for secrets.
*   **Docker:** `Dockerfile` for building the C++ application image, `docker-compose.yml` for orchestrating the application and PostgreSQL database.
*   **CI/CD:** GitHub Actions workflow (`.github/workflows/main.yml`) automates building, testing, and potentially deployment.

## 5. Scalability and Performance

*   **Asynchronous Processing:** Drogon's non-blocking nature allows high concurrency on a single server.
*   **Database Connection Pooling:** Managed by Drogon's DbClient.
*   **Caching:** In-memory `CacheService` reduces database reads for frequently accessed, relatively static data.
*   **Load Balancing:** The architecture supports horizontal scaling by running multiple Drogon instances behind a load balancer.
*   **Stateless JWTs:** Primarily stateless, making horizontal scaling easier (session invalidation with `sessions` table adds a small state dependency, which can be scaled with a distributed cache like Redis if needed).

## 6. Future Enhancements

*   **Distributed Caching:** Integrate Redis for a shared cache layer for `CacheService` and JWT blacklisting.
*   **Asynchronous Task Queues:** For long-running operations (e.g., email notifications).
*   **Observability:** Integrate with Prometheus for metrics, ELK stack for centralized logging, and Jaeger for distributed tracing.
*   **OAuth2/OIDC:** Implement external identity provider integration.
*   **Password Reset/Forgot Password Flows.**
*   **MFA (Multi-Factor Authentication).**
*   **More Granular Permissions:** Beyond simple roles to individual permissions.
*   **Full-fledged Frontend:** Replace server-rendered HTML with a modern SPA (React, Vue, Angular) interacting with the C++ backend APIs.
```